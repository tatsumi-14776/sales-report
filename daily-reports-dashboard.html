<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日報管理ダッシュボード - 日次売上報告書システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: linear-gradient(45deg, #e91e63, #c2185b);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* 統計サマリー */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stats-icon {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stats-icon.submitted {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .stats-icon.pending {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .stats-icon.total-sales {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .stats-info h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .stats-info p {
            color: #666;
            font-size: 0.875rem;
        }

        /* フィルター・検索エリア */
        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .filter-input,
        .filter-select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #e91e63;
        }

        .filter-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(45deg, #e91e63, #c2185b);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        /* 日報一覧テーブル */
        .reports-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-button {
            padding: 0.5rem 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .reports-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .reports-table th,
        .reports-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .reports-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .reports-table tr:hover {
            background: #f8f9fa;
        }

        /* ステータスバッジ */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
            display: inline-block;
        }

        .status-submitted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-confirm {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
            font-weight: 600;
        }

        .btn-confirm:hover {
            background: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-view {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn-view:hover {
            background: #bbdefb;
        }

        .btn-edit {
            background: #fff3e0;
            color: #ef6c00;
        }

        .btn-edit:hover {
            background: #ffe0b2;
        }

        .btn-download {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .btn-download:hover {
            background: #c8e6c9;
        }

        /* 売上金額のフォーマット */
        .sales-amount {
            font-weight: 600;
            color: #2563eb;
            text-align: right;
        }

        /* ローディング */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 空状態 */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* アラート */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #059669;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #dc2626;
            color: #991b1b;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .stats-overview {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .reports-table {
                min-width: 800px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* 詳細モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: #333;
        }

        .btn-confirm {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
            font-weight: 600;
        }

        .btn-confirm:hover {
            background: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
                /* 確定済みステータスバッジ */
        .status-confirmed {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #d97706;
        }

        .status-draft {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #9ca3af;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
        }

        /* 確定済みアクションボタン */
        .btn-confirmed {
            background: #fef3c7 !important;
            color: #92400e !important;
            border: 1px solid #d97706 !important;
            cursor: default !important;
            opacity: 0.8;
            font-weight: 600;
        }

        .btn-confirmed:hover {
            background: #fef3c7 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-confirmed::before {
            content: "🔒 ";
            margin-right: 4px;
        }

        /* 追加のステータス表示 */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
            display: inline-block;
        }

        .quick-filter-btn {
            padding: 0.5rem 0.75rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
        }

        .quick-filter-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .clear-filter-btn {
            padding: 0.5rem 0.75rem;
            background: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #dc2626;
        }

        .clear-filter-btn:hover {
            background: #fecaca;
            border-color: #f87171;
            transform: translateY(-1px);
        }

        /* 必須マークのスタイル */
        .filter-label span {
            font-weight: bold;
        }

        /* 検索ボタンの強化 */
        .filter-button {
            position: relative;
            overflow: hidden;
        }

        .filter-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .filter-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* 検索状態表示 */
        .search-status-loading {
            background: #dbeafe !important;
            color: #1e40af !important;
            border: 1px solid #3b82f6;
        }

        .search-status-success {
            background: #d1fae5 !important;
            color: #065f46 !important;
            border: 1px solid #059669;
        }

        .search-status-error {
            background: #fee2e2 !important;
            color: #991b1b !important;
            border: 1px solid #dc2626;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <div class="header-left">
                <div class="admin-badge">📊 日報管理</div>
                <div>
                    <h1 style="margin-bottom: 0.25rem;">日報管理</h1>
                    <div style="font-size: 0.875rem; color: #666;" id="userInfo">読み込み中...</div>
                </div>
            </div>
            <div class="nav-buttons">
                <a href="admin.html" class="nav-btn secondary">
                    <span>🏠</span>
                    ダッシュボード
                </a>
                <button class="nav-btn secondary" onclick="handleLogout()">
                    <span>🚪</span>
                    ログアウト
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- 統計サマリー -->
            <div class="stats-overview">
                <div class="stats-card">
                    <div class="stats-icon submitted">✅</div>
                    <div class="stats-info">
                        <h3 id="submittedCount">-</h3>
                        <p>提出済み店舗</p>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon pending">⏳</div>
                    <div class="stats-info">
                        <h3 id="pendingCount">-</h3>
                        <p>未提出店舗</p>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon total-sales">💰</div>
                    <div class="stats-info">
                        <h3 id="totalSales">-</h3>
                        <p>合計売上額</p>
                    </div>
                </div>
            </div>

            <!-- フィルター・検索エリア（改善版） -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">開始日 <span style="color: #dc2626;">*</span></label>
                        <input type="date" id="filterStartDate" class="filter-input" placeholder="開始日を選択">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">終了日 <span style="color: #dc2626;">*</span></label>
                        <input type="date" id="filterEndDate" class="filter-input" placeholder="終了日を選択">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">店舗</label>
                        <select id="filterStore" class="filter-select">
                            <option value="">すべての店舗</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ステータス</label>
                        <select id="filterStatus" class="filter-select">
                            <option value="">すべて</option>
                            <option value="draft">提出済み</option>
                            <option value="approved">確定済み</option>
                            <option value="pending">未提出</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">&nbsp;</label>
                        <button class="filter-button" onclick="performSearch()" id="searchButton">
                            <span>🔍</span> 検索
                        </button>
                    </div>
                </div>
                
                <!-- 便利ボタン群 -->
                <div class="quick-filters" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 0.875rem; color: #666; margin-right: 0.5rem;">クイック設定:</span>
                    <button class="quick-filter-btn" onclick="setTodayDate()" title="今日の日付を設定">
                        📅 今日
                    </button>
                    <button class="quick-filter-btn" onclick="setThisWeekRange()" title="今週の範囲を設定">
                        📅 今週
                    </button>
                    <button class="quick-filter-btn" onclick="setLastWeekRange()" title="先週の範囲を設定">
                        📅 先週
                    </button>
                    <button class="quick-filter-btn" onclick="setThisMonthRange()" title="今月の範囲を設定">
                        📅 今月
                    </button>
                    <button class="quick-filter-btn" onclick="setLastMonthRange()" title="先月の範囲を設定">
                        📅 先月
                    </button>
                    <div style="flex: 1;"></div>
                    <button class="clear-filter-btn" onclick="clearDateRange()" title="すべてクリア">
                        🗑️ クリア
                    </button>
                </div>
                </div>
                
                <!-- 検索状態表示 -->
                <div id="searchStatus" style="margin-top: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; font-size: 0.875rem; color: #666; display: none;">
                    <span id="searchStatusText">検索条件を設定してください</span>
                </div>
            </div>

            <!-- アラートエリア -->
            <div id="alertContainer"></div>

            <!-- 日報一覧 -->
            <div class="reports-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>📋</span>
                        日報一覧
                    </h2>
                    <button class="export-button" onclick="exportReports()">
                        <span>📄</span> CSV出力
                    </button>
                </div>

                <!-- ローディング -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>データを読み込み中...</p>
                </div>

                <!-- テーブル -->
                <div class="reports-table-container" id="reportsTableContainer">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>店舗名</th>
                                <th>担当者</th>
                                <th>ステータス</th>
                                <th>売上合計</th>
                                <th>現金過不足</th>
                                <th>提出日時</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- データがJavaScriptで挿入される -->
                        </tbody>
                    </table>
                </div>

                <!-- 空状態 -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>日報データがありません</h3>
                    <p>指定された条件に一致する日報が見つかりませんでした</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 日報詳細モーダル -->
    <div class="modal" id="reportDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">日報詳細</h3>
                <button class="close-btn" onclick="closeReportDetail()">&times;</button>
            </div>
            
            <div id="reportDetailContent">
                <!-- 日報詳細内容がJavaScriptで挿入される -->
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let allReports = [];
        let allStores = [];
        let currentFilters = {
            date: '',
            store: '',
            status: ''
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializePage();
        });

        // 認証チェック
        function checkAuth() {
            const userSession = JSON.parse(sessionStorage.getItem('userSession') || 'null');
            
            if (!userSession || userSession.role !== 'admin') {
                alert('管理者としてログインしてください');
                window.location.href = 'login.html';
                return;
            }

            const userInfo = document.getElementById('userInfo');
            if (userInfo && userSession.username) {
                userInfo.textContent = `${userSession.username} さんでログイン中`;
            }
        }

        // ページ初期化（前日日付設定版）
        async function initializePage() {
            try {
                console.log('日報管理画面初期化開始（検索ボタン待機）');
                disableSearchButton(true, '店舗一覧を読み込み中...');
                
                // 前日の日付を設定
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayString = yesterday.toISOString().split('T')[0];
                
                const startDateField = document.getElementById('filterStartDate');
                const endDateField = document.getElementById('filterEndDate');
                
                if (startDateField) {
                    startDateField.value = yesterdayString;
                    console.log('開始日フィールドに前日を設定:', yesterdayString);
                }
                
                if (endDateField) {
                    endDateField.value = yesterdayString;
                    console.log('終了日フィールドに前日を設定:', yesterdayString);
                }
                
                // 店舗一覧のみ読み込み（データは読み込まない）
                await loadStores();
                console.log('店舗一覧の読み込み完了');
                 disableSearchButton(false);

                // 初期状態メッセージを表示
                showInitialMessage();
                
                console.log('日報管理画面初期化完了（検索待機状態）');
                
            } catch (error) {
                console.error('初期化エラー:', error);
                showAlert('初期化に失敗しました', 'error');
            }
        }

        // 店舗一覧読み込み
        async function loadStores() {
            try {
                const response = await fetch('api.php?action=getAllStores');
                const result = await response.json();

                if (result.success) {
                    // 本社を除外してフィルタリング
                    allStores = (result.data || []).filter(store => {
                        // 店舗名に「本社」が含まれる場合は除外
                        return !store.store_name.includes('本社');
                    });
                    console.log(`店舗一覧を取得（本社除外後: ${allStores.length}件）`);
                    updateStoreFilter();
                } else {
                    console.error('店舗一覧の取得に失敗:', result.message);
                }
            } catch (error) {
                console.error('店舗読み込みエラー:', error);
            }
        }

        // 店舗フィルターを更新
        function updateStoreFilter() {
            const filterStore = document.getElementById('filterStore');
            filterStore.innerHTML = '<option value="">すべての店舗</option>';
            
            allStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.store_name;
                filterStore.appendChild(option);
            });
        }

        /**
         * 日報データ読み込み（並列処理版）
         */
        async function loadReports() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showInitialMessage();
                return;
            }
            
            showLoading(true);
            
            try {
                if (startDate > endDate) {
                    showAlert('開始日は終了日より前の日付を指定してください', 'error');
                    return;
                }
                
                const dateRange = getDateRange(startDate, endDate);
                console.log(`並列データ読み込み: ${startDate} ～ ${endDate} (${dateRange.length}日)`);
                
                if (!allStores || allStores.length === 0) {
                    throw new Error('店舗一覧が読み込まれていません。ページを再読み込みしてください。');
                }
                
                // 並列リクエスト配列を準備
                const requestPromises = [];
                
                // 各店舗・各日付の組み合わせでPromiseを作成
                for (const store of allStores) {
                    for (const date of dateRange) {
                        const promise = fetchReportData(store, date);
                        requestPromises.push(promise);
                    }
                }
                
                console.log(`並列リクエスト数: ${requestPromises.length}`);
                
                // すべてのリクエストを並列実行
                const results = await Promise.allSettled(requestPromises);
                
                // 結果を処理
                const reports = [];
                let successCount = 0;
                let errorCount = 0;
                
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        reports.push(result.value);
                        successCount++;
                    } else {
                        console.error('リクエストエラー:', result.reason);
                        errorCount++;
                    }
                });
                
                console.log(`並列データ読み込み完了: ${reports.length}件 (成功: ${successCount}, エラー: ${errorCount})`);
                
                allReports = reports;
                applyFilters();
                updateStats();
                
                if (errorCount > 0) {
                    showAlert(`データを読み込みました（${reports.length}件）\n一部取得できないデータがありました（${errorCount}件）`, 'warning');
                }
                
            } catch (error) {
                console.error('並列データ読み込みエラー:', error);
                showAlert('日報データの読み込みに失敗しました: ' + error.message, 'error');
                allReports = [];
                showInitialMessage();
            } finally {
                showLoading(false);
            }
        }

        // 日付範囲を生成するヘルパー関数
        function getDateRange(startDate, endDate) {
            const dates = [];
            const currentDate = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            while (currentDate <= endDateObj) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }

        // 売上合計を計算
        function calculateTotalSales(reportData) {
            try {
                let total = 0;
                
                // 売上データから計算
                if (reportData.sales_data) {
                    const salesData = typeof reportData.sales_data === 'string' 
                        ? JSON.parse(reportData.sales_data) 
                        : reportData.sales_data;
                    
                    Object.values(salesData).forEach(amount => {
                        total += parseFloat(amount) || 0;
                    });
                }
                
                // ポイント支払データから計算
                if (reportData.point_payments_data) {
                    const pointData = typeof reportData.point_payments_data === 'string' 
                        ? JSON.parse(reportData.point_payments_data) 
                        : reportData.point_payments_data;
                    
                    Object.values(pointData).forEach(amount => {
                        total += parseFloat(amount) || 0;
                    });
                }
                
                return total;
            } catch (error) {
                console.error('売上計算エラー:', error);
                return 0;
            }
        }

        // フィルター適用（修正版）
        function applyFilters() {
            console.log('=== applyFilters 実行開始 ===');
            
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            console.log('フィルター条件:', {startDate, endDate});
            
            // 日付が設定されていない場合は初期メッセージを表示
            if (!startDate || !endDate) {
                console.log('日付が未設定のため初期メッセージを表示');
                showInitialMessage();
                return;
            }
            
            // window.allReportsを使用
            if (!window.allReports || !Array.isArray(window.allReports)) {
                console.error('window.allReportsが正しく設定されていません:', window.allReports);
                showInitialMessage();
                return;
            }
            
            currentFilters.startDate = startDate;
            currentFilters.endDate = endDate;
            currentFilters.store = document.getElementById('filterStore').value;
            currentFilters.status = document.getElementById('filterStatus').value;
            
            console.log('設定されたフィルター:', currentFilters);
            
            let filteredReports = [...window.allReports];
            console.log('フィルター前:', filteredReports.length);
            
            // 期間フィルター
            if (currentFilters.startDate && currentFilters.endDate) {
                filteredReports = filteredReports.filter(report => 
                    report.report_date >= currentFilters.startDate && 
                    report.report_date <= currentFilters.endDate
                );
                console.log('期間フィルター後:', filteredReports.length);
            }
            
            // 店舗フィルター
            if (currentFilters.store) {
                filteredReports = filteredReports.filter(report => 
                    report.store_id == currentFilters.store
                );
                console.log('店舗フィルター後:', filteredReports.length);
            }
            
            // ステータスフィルター
            if (currentFilters.status) {
                if (currentFilters.status === 'draft') {
                    // 「提出済み」を選択した場合、draftとsubmittedの両方を含める
                    filteredReports = filteredReports.filter(report => 
                        report.status === 'draft' || report.status === 'submitted'
                    );
                } else if (currentFilters.status === 'approved') {
                    // 「確定済み」を選択した場合、approvedのみ
                    filteredReports = filteredReports.filter(report => 
                        report.status === 'approved'
                    );
                } else {
                    filteredReports = filteredReports.filter(report => 
                        report.status === currentFilters.status
                    );
                }
                console.log('ステータスフィルター後:', filteredReports.length);
            }
            
            console.log('最終フィルター結果:', filteredReports.length);
            
            // 簡易テーブル表示（動作確認済み）
            const tbody = document.getElementById('reportsTableBody');
            const tableContainer = document.getElementById('reportsTableContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredReports.length > 0) {
                tableContainer.style.display = 'block';
                emptyState.style.display = 'none';
                
                tbody.innerHTML = filteredReports.map(report => `
                    <tr>
                        <td>${formatDate(report.report_date)}</td>
                        <td><strong>${escapeHtml(report.store_name)}</strong></td>
                        <td>${escapeHtml(report.user_id || '-')}</td>
                        <td>${getStatusBadge(report.status)}</td>
                        <td class="sales-amount">${formatCurrency(report.total_sales)}</td>
                        <td style="text-align: right;">${formatCurrency(report.cash_difference)}</td>
                        <td>${formatDateTime(report.updated_at)}</td>
                        <td>
                            <div class="action-buttons">
                                ${getActionButtons(report)}
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                console.log('✅ テーブル表示完了');
            } else {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                console.log('データ0件のため空状態表示');
            }
        }

        /**
         * テーブル描画（status対応版）
         */
        function renderReportsTable(reports) {
            const tbody = document.getElementById('reportsTableBody');
            const tableContainer = document.getElementById('reportsTableContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (reports.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>${formatDate(report.report_date)}</td>
                    <td><strong>${escapeHtml(report.store_name)}</strong></td>
                    <td>${escapeHtml(report.user_id || '-')}</td>
                    <td>${getStatusBadge(report.status)}</td>
                    <td class="sales-amount">${formatCurrency(report.total_sales)}</td>
                    <td style="text-align: right; ${report.cash_difference > 0 ? 'color: #059669;' : report.cash_difference < 0 ? 'color: #dc2626;' : ''}">${formatCurrency(report.cash_difference)}</td>
                    <td>${formatDateTime(report.updated_at)}</td>
                    <td>
                        <div class="action-buttons">
                            ${getActionButtons(report)}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 統計更新
        function updateStats() {
            const submitted = allReports.filter(r => r.status === 'submitted' || r.status === 'draft').length;
            const pending = allReports.filter(r => r.status === 'pending').length;
            const totalSales = allReports
                .filter(r => r.status === 'submitted' || r.status === 'draft')
                .reduce((sum, r) => sum + r.total_sales, 0);
            
            document.getElementById('submittedCount').textContent = submitted;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
        }

        /**
         * ステータスバッジ生成（status対応版）
         */
        function getStatusBadge(status) {
            const badges = {
                'submitted': '<span class="status-badge status-submitted">✅ 提出済み</span>',
                'approved': '<span class="status-badge status-confirmed">✅ 確定済み</span>',
                'draft': '<span class="status-badge status-draft">📝 提出済み</span>',
                'rejected': '<span class="status-badge status-rejected">❌ 却下</span>',
                'pending': '<span class="status-badge status-pending">⏳ 未提出</span>'
            };
            return badges[status] || '<span class="status-badge">不明</span>';
        }

        /**
         * アクションボタン生成（status対応版・修正版）
         */
        function getActionButtons(report) {
            if (!report.id) {
                // 未提出の場合
                return `<button class="btn-small btn-edit" onclick="createReport(${report.store_id}, '${report.report_date}')">✏️ 作成</button>`;
            }
            
            // デバッグ用ログ
            console.log(`Report ID: ${report.id}, Status: ${report.status}, Date: ${report.report_date}`);
            
            // 提出済みの場合（statusの確認を強化）
            if (report.status === 'approved') {
                // 確定済みの場合（クリック可能）
                return `
                    <button class="btn-small btn-confirmed" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')" title="この日報は確定済みです">🔒 確定済み</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">👁️ 詳細</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">📄 PDF</button>
                `;
            } else if (report.status === 'submitted') {
                // 提出済み・未確定の場合
                return `
                    <button class="btn-small btn-confirm" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">📋 確認</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">👁️ 詳細</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">📄 PDF</button>
                `;
            } else if (report.status === 'draft') {
                // 下書きの場合
                return `
                    <button class="btn-small btn-edit" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">✏️ 編集</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">👁️ 詳細</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">📄 PDF</button>
                `;
            } else if (report.status === 'rejected') {
                // 却下の場合
                return `
                    <button class="btn-small btn-edit" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">🔄 再編集</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">👁️ 詳細</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">📄 PDF</button>
                `;
            } else {
                // その他・不明なステータスの場合（フォールバック）
                console.warn(`Unknown status: ${report.status} for report ID: ${report.id}`);
                return `
                    <button class="btn-small btn-view" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">📋 確認</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">👁️ 詳細</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">📄 PDF</button>
                `;
            }
        }

        // 日報詳細表示
        async function viewReportDetail(reportId) {
            try {
                // APIから詳細データを取得
                const report = allReports.find(r => r.id == reportId);
                if (!report) return;
                
                const detailContent = document.getElementById('reportDetailContent');
                detailContent.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">日付</div>
                            <div class="detail-value">${formatDate(report.report_date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">店舗</div>
                            <div class="detail-value">${escapeHtml(report.store_name)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">担当者</div>
                            <div class="detail-value">${escapeHtml(report.user_id)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">売上合計</div>
                            <div class="detail-value">${formatCurrency(report.total_sales)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">現金過不足</div>
                            <div class="detail-value">${formatCurrency(report.cash_difference)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">提出日時</div>
                            <div class="detail-value">${formatDateTime(report.updated_at)}</div>
                        </div>
                    </div>
                    
                    ${report.remarks ? `
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">備考・報告事項</h4>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(report.remarks)}</div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('reportDetailModal').classList.add('show');
                
            } catch (error) {
                console.error('詳細表示エラー:', error);
                showAlert('詳細の読み込みに失敗しました', 'error');
            }
        }

        // 日報をフォーム形式で確認
        function viewReportInForm(storeId, reportDate) {
            try {
                console.log(`日報確認: 店舗ID=${storeId}, 日付=${reportDate}`);
                
                // index.htmlに店舗IDと日付をパラメータとして渡す
                const url = `index.html?store_id=${storeId}&date=${reportDate}&mode=view`;
                window.open(url, '_blank');
                
            } catch (error) {
                console.error('日報確認でエラー:', error);
                showAlert('日報の確認に失敗しました', 'error');
            }
        }

        // 日報をフォーム形式で確認
        function viewReportInForm(storeId, reportDate) {
            try {
                console.log(`日報確認: 店舗ID=${storeId}, 日付=${reportDate}`);
                
                // index.htmlに店舗IDと日付をパラメータとして渡す
                const url = `index.html?store_id=${storeId}&date=${reportDate}&mode=view`;
                window.open(url, '_blank');
                
            } catch (error) {
                console.error('日報確認でエラー:', error);
                showAlert('日報の確認に失敗しました', 'error');
            }
        }

        // 日報作成
        function createReport(storeId, date) {
            const url = `index.html?store_id=${storeId}&date=${date}&mode=create`;
            window.open(url, '_blank');
        }

        // PDF出力
        function downloadReport(reportId) {
            // PDF生成機能は実装予定
            showAlert('PDF出力機能は開発中です', 'error');
        }

        // CSV出力
        function exportReports() {
            try {
                const filteredReports = allReports.filter(report => {
                    if (currentFilters.store && report.store_id != currentFilters.store) return false;
                    if (currentFilters.status && report.status !== currentFilters.status) return false;
                    return true;
                });
                
                const csvData = [
                    ['日付', '店舗名', '担当者', 'ステータス', '売上合計', '現金過不足', '提出日時'],
                    ...filteredReports.map(report => [
                        report.report_date,
                        report.store_name,
                        report.user_id || '-',
                        report.status === 'draft' ? '提出済み' : 
                        report.status === 'approved' ? '確定済み' : 
                        report.status === 'submitted' ? '提出済み' : 
                        report.status === 'pending' ? '未提出' : '不明',
                        report.total_sales,
                        report.cash_difference,
                        report.updated_at || '-'
                    ])
                ];
                
                const csvContent = csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `日報一覧_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
            } catch (error) {
                console.error('CSV出力エラー:', error);
                showAlert('CSV出力に失敗しました', 'error');
            }
        }

        // モーダルを閉じる
        function closeReportDetail() {
            document.getElementById('reportDetailModal').classList.remove('show');
        }

        // ローディング表示/非表示
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // アラート表示
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // ユーティリティ関数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }

        function formatCurrency(amount) {
            return `¥${amount.toLocaleString()}`;
        }

        // モーダル外クリックで閉じる
        document.getElementById('reportDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportDetail();
            }
        });

        // ESCキーでモーダルを閉じる
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeReportDetail();
            }
        });

        // フィルター入力時の自動更新
        document.getElementById('filterStartDate').addEventListener('change', validateDateRange);
        document.getElementById('filterEndDate').addEventListener('change', validateDateRange);

        // 日付範囲のバリデーション（自動読み込みなし版）
        function validateDateRange() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const searchButton = document.getElementById('searchButton');
            const searchStatus = document.getElementById('searchStatus');
            const searchStatusText = document.getElementById('searchStatusText');
            
            if (startDate && endDate) {
                if (startDate > endDate) {
                    // エラー状態
                    document.getElementById('filterStartDate').style.borderColor = '#dc2626';
                    document.getElementById('filterEndDate').style.borderColor = '#dc2626';
                    if (searchButton) searchButton.disabled = true;
                    
                    if (searchStatus && searchStatusText) {
                        searchStatus.style.display = 'block';
                        searchStatus.className = 'search-status-error';
                        searchStatusText.textContent = '開始日は終了日より前の日付を指定してください';
                    }
                } else {
                    // 正常状態
                    document.getElementById('filterStartDate').style.borderColor = '#059669';
                    document.getElementById('filterEndDate').style.borderColor = '#059669';
                    if (searchButton) searchButton.disabled = false;
                    
                    // 期間の日数を表示
                    const daysDiff = Math.floor((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                    
                    if (searchStatus && searchStatusText) {
                        searchStatus.style.display = 'block';
                        searchStatus.className = '';
                        searchStatusText.textContent = `${daysDiff + 1}日間の期間が選択されています。検索ボタンを押してデータを読み込んでください。`;
                    }
                }
            } else {
                // 入力途中
                document.getElementById('filterStartDate').style.borderColor = '';
                document.getElementById('filterEndDate').style.borderColor = '';
                if (searchButton) searchButton.disabled = !startDate || !endDate;
                
                if (searchStatus) {
                    searchStatus.style.display = 'none';
                }
            }
        }
/**
 * 初期状態メッセージを表示（前日日付設定版）
 */
function showInitialMessage() {
    const reportsTableContainer = document.getElementById('reportsTableContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (reportsTableContainer && emptyState) {
        // テーブルを非表示
        reportsTableContainer.style.display = 'none';
        
        // 前日の日付を取得
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayString = yesterday.toLocaleDateString('ja-JP');
        
        // 初期メッセージを表示
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #666;">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">📋</div>
                <h3 style="margin-bottom: 1rem; color: #333;">検索ボタンを押してデータを読み込んでください</h3>
                <p style="margin-bottom: 0.5rem;">初期設定で前日（${yesterdayString}）の範囲が選択されています</p>
                <p style="font-size: 0.875rem; opacity: 0.7;">日付を変更してから「🔍 検索」ボタンを押してください</p>
            </div>
        `;
        console.log('初期メッセージを表示（前日日付設定済み）');
    }
    
    // 統計も初期状態に設定
    resetStats();
}

/**
 * 統計を初期状態にリセット
 */
function resetStats() {
    try {
        document.getElementById('submittedCount').textContent = '-';
        document.getElementById('pendingCount').textContent = '-';
        document.getElementById('totalSales').textContent = '-';
        console.log('統計を初期状態にリセット');
    } catch (error) {
        console.error('統計リセットエラー:', error);
    }
}

/**
 * 検索処理（バッチAPI使用版）
 */
async function performSearch() {
    console.log('高速検索処理開始');
    
    try {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        // 必須チェック
        if (!startDate || !endDate) {
            showAlert('開始日と終了日を両方とも選択してください', 'error');
            return;
        }
        
        // 日付妥当性チェック
        if (startDate > endDate) {
            showAlert('開始日は終了日より前の日付を指定してください', 'error');
            return;
        }
        
        // 期間制限チェック（30日以内推奨）
        const daysDiff = Math.floor((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
        if (daysDiff > 30) {
            if (!confirm(`${daysDiff + 1}日間のデータを読み込みます。\n時間がかかる場合があります。続行しますか？`)) {
                return;
            }
        }
        
        console.log(`高速検索実行: ${startDate} ～ ${endDate} (${daysDiff + 1}日間)`);
        
        // バッチAPI版のデータ読み込み実行
        await loadReportsFast();
        
    } catch (error) {
        console.error('高速検索エラー:', error);
        showAlert('検索中にエラーが発生しました: ' + error.message, 'error');
    }
}

    /**
     * 今日の日付を設定するボタン
     */
    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterStartDate').value = today;
        document.getElementById('filterEndDate').value = today;
        console.log('今日の日付を設定:', today);
    }

    /**
     * 今週の日付範囲を設定するボタン
     */
    function setThisWeekRange() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0=日曜日, 1=月曜日, ...
        const monday = new Date(today);
        monday.setDate(today.getDate() - dayOfWeek + 1); // 月曜日
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // 日曜日
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        document.getElementById('filterStartDate').value = startDate;
        document.getElementById('filterEndDate').value = endDate;
        console.log('今週の範囲を設定:', startDate, '～', endDate);
    }

    /**
     * 先週の日付範囲を設定
     */
    function setLastWeekRange() {
        const today = new Date();
        const dayOfWeek = today.getDay();
        const lastMonday = new Date(today);
        lastMonday.setDate(today.getDate() - dayOfWeek - 6); // 先週の月曜日
        const lastSunday = new Date(lastMonday);
        lastSunday.setDate(lastMonday.getDate() + 6); // 先週の日曜日
        
        const startDate = lastMonday.toISOString().split('T')[0];
        const endDate = lastSunday.toISOString().split('T')[0];
        
        document.getElementById('filterStartDate').value = startDate;
        document.getElementById('filterEndDate').value = endDate;
        console.log('先週の範囲を設定:', startDate, '～', endDate);
    }

    /**
     * 今月の日付範囲を設定（修正版）
     */
    function setThisMonthRange() {
        const today = new Date();
        
        // 今月の1日
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // 今月の最終日
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // ローカル時間で日付文字列を生成（YYYY-MM-DD形式）
        const startDate = formatDateLocal(firstDay);
        const endDate = formatDateLocal(lastDay);
        
        document.getElementById('filterStartDate').value = startDate;
        document.getElementById('filterEndDate').value = endDate;
        
        // ガイダンス表示
        const searchStatus = document.getElementById('searchStatus');
        const searchStatusText = document.getElementById('searchStatusText');
        if (searchStatus && searchStatusText) {
            searchStatus.style.display = 'block';
            searchStatus.className = '';
            const dayCount = lastDay.getDate();
            searchStatusText.textContent = `今月の範囲（${dayCount}日間）が設定されました。検索ボタンを押してデータを読み込んでください。`;
        }
        
        console.log('今月の範囲を設定:', startDate, '～', endDate);
    }

    /**
 * 先月の日付範囲を設定
 */
function setLastMonthRange() {
    const today = new Date();
    
    // 先月の1日
    const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    
    // 先月の最終日
    const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
    
    // ローカル時間で日付文字列を生成（YYYY-MM-DD形式）
    const startDate = formatDateLocal(firstDay);
    const endDate = formatDateLocal(lastDay);
    
    document.getElementById('filterStartDate').value = startDate;
    document.getElementById('filterEndDate').value = endDate;
    
    // ガイダンス表示
    const searchStatus = document.getElementById('searchStatus');
    const searchStatusText = document.getElementById('searchStatusText');
    if (searchStatus && searchStatusText) {
        searchStatus.style.display = 'block';
        searchStatus.className = '';
        const dayCount = lastDay.getDate();
        const monthName = lastDay.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
        searchStatusText.textContent = `${monthName}の範囲（${dayCount}日間）が設定されました。検索ボタンを押してデータを読み込んでください。`;
    }
    
    console.log('先月の範囲を設定:', startDate, '～', endDate);
}

    /**
     * ローカル時間で日付をYYYY-MM-DD形式に変換
     * @param {Date} date 
     * @returns {string} YYYY-MM-DD形式の日付文字列
     */
    function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    /**
     * 日付範囲のクリアボタン
     */
    function clearDateRange() {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterStore').value = '';
        document.getElementById('filterStatus').value = '';
        
        // 初期状態に戻す
        allReports = [];
        showInitialMessage();
        
        console.log('日付範囲とフィルターをクリア');
    }
    /**
     * 個別レポートデータ取得（Promise対応）
     */
    async function fetchReportData(store, date) {
        try {
            const response = await fetch(`api.php?action=getReport&report_date=${date}&store_id=${store.id}`);
            const result = await response.json();
            
            if (result.success) {
                // 提出済み
                const reportData = result.data;
                const status = reportData.status || 'submitted';
                
                return {
                    ...reportData,
                    store_name: store.store_name,
                    status: status,
                    total_sales: calculateTotalSales(reportData)
                };
            } else {
                // 未提出
                return {
                    id: null,
                    report_date: date,
                    store_id: store.id,
                    store_name: store.store_name,
                    user_id: '-',
                    status: 'pending',
                    total_sales: 0,
                    cash_difference: 0,
                    created_at: null,
                    updated_at: null
                };
            }
        } catch (error) {
            console.error(`店舗 ${store.store_name} - ${date} のデータ取得エラー:`, error);
            // エラー時も未提出として返す
            return {
                id: null,
                report_date: date,
                store_id: store.id,
                store_name: store.store_name,
                user_id: '-',
                status: 'pending',
                total_sales: 0,
                cash_difference: 0,
                created_at: null,
                updated_at: null
            };
        }
    }

    /**
     * バッチAPI使用版の高速データ読み込み
     */
    async function loadReportsFast() {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        if (!startDate || !endDate) {
            showInitialMessage();
            return;
        }
        
        showLoading(true);
        
        try {
            if (!allStores || allStores.length === 0) {
                throw new Error('店舗一覧が読み込まれていません。');
            }
            
            // 店舗IDの配列を作成
            const storeIds = allStores.map(store => store.id);
            
            console.log(`バッチAPI呼び出し: ${startDate} ～ ${endDate}, 店舗数: ${storeIds.length}`);
            
            // バッチAPIを呼び出し
            const response = await fetch('api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'getBatchReports',
                    start_date: startDate,
                    end_date: endDate,
                    store_ids: storeIds
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const existingReports = result.data;
                console.log(`バッチAPI取得完了: ${existingReports.length}件の既存レポート`);
                
                // 全組み合わせを生成して未提出データを補完
                const completeReports = generateCompleteReportSet(startDate, endDate, allStores, existingReports);
                console.log(`データ補完完了: ${completeReports.length}件の全レポート`);
                
                window.allReports = completeReports;
                console.log('✅ グローバル変数設定確認:', window.allReports ? window.allReports.length : 'FAILED');
                if (window.allReports && window.allReports.length > 0) {
                    console.log('applyFilters() を実行');
                    applyFilters();
                    updateStats();
                } else {
                    console.error('❌ グローバル変数の設定に失敗');
                    showInitialMessage();
                }
                
            } else {
                throw new Error(result.message || 'バッチAPI呼び出しに失敗しました');
            }
            
        } catch (error) {
            console.error('高速データ読み込みエラー:', error);
            showAlert('日報データの読み込みに失敗しました: ' + error.message, 'error');
            window.allReports = [];
            showInitialMessage();
        } finally {
            showLoading(false);
        }
    }

    /**
     * 完全なレポートセットを生成（未提出データを補完）
     */
    function generateCompleteReportSet(startDate, endDate, stores, existingReports) {
        const dateRange = getDateRange(startDate, endDate);
        const completeReports = [];
        
        // 既存レポートをマップ化（高速検索用）
        const existingMap = new Map();
        existingReports.forEach(report => {
            const key = `${report.store_id}-${report.report_date}`;
            // 売上合計を計算
            report.total_sales = calculateTotalSalesFromData(report);
            existingMap.set(key, report);
        });
        
        // 全組み合わせをチェック
        stores.forEach(store => {
            dateRange.forEach(date => {
                const key = `${store.id}-${date}`;
                
                if (existingMap.has(key)) {
                    // 既存レポートがある場合
                    const existingReport = existingMap.get(key);
                    completeReports.push({
                        ...existingReport,
                        store_name: store.store_name
                    });
                } else {
                    // 未提出の場合
                    completeReports.push({
                        id: null,
                        report_date: date,
                        store_id: store.id,
                        store_name: store.store_name,
                        user_id: '-',
                        status: 'pending',
                        total_sales: 0,
                        cash_difference: 0,
                        created_at: null,
                        updated_at: null
                    });
                }
            });
        });
        
        return completeReports;
    }

    /**
     * レポートデータから売上合計を計算
     */
    function calculateTotalSalesFromData(reportData) {
        try {
            let total = 0;
            
            if (reportData.sales_data) {
                Object.values(reportData.sales_data).forEach(amount => {
                    total += parseFloat(amount) || 0;
                });
            }
            
            if (reportData.point_payments_data) {
                Object.values(reportData.point_payments_data).forEach(amount => {
                    total += parseFloat(amount) || 0;
                });
            }
            
            return total;
        } catch (error) {
            return 0;
        }
    }

    /**
 * 検索ボタンの有効/無効制御
 * @param {boolean} disabled true=無効, false=有効
 * @param {string} message 無効時に表示するメッセージ
 */
function disableSearchButton(disabled, message = '') {
    const searchButton = document.getElementById('searchButton');
    const searchStatus = document.getElementById('searchStatus');
    const searchStatusText = document.getElementById('searchStatusText');
    
    if (!searchButton) return;
    
    if (disabled) {
        // 無効化
        searchButton.disabled = true;
        searchButton.style.opacity = '0.6';
        searchButton.style.cursor = 'not-allowed';
        searchButton.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>${message || '処理中...'}</span>
            </div>
        `;
        
        // ステータス表示
        if (searchStatus && searchStatusText) {
            searchStatus.style.display = 'block';
            searchStatus.className = 'search-status-loading';
            searchStatusText.textContent = message || '初期化中です。しばらくお待ちください。';
        }
        
    } else {
        // 有効化
        searchButton.disabled = false;
        searchButton.style.opacity = '1';
        searchButton.style.cursor = 'pointer';
        searchButton.innerHTML = `
            <span>🔍</span> 検索
        `;
        
        // ステータス非表示
        if (searchStatus) {
            searchStatus.style.display = 'none';
        }
        
        console.log('✅ 検索ボタンが有効になりました');
    }
}

    // アニメーション用CSS追加（1回のみ）
    if (!document.getElementById('searchButtonSpinCSS')) {
        const style = document.createElement('style');
        style.id = 'searchButtonSpinCSS';
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
        
    </script>
</body>
</html>