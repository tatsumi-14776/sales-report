<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å ±ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - æ—¥æ¬¡å£²ä¸Šå ±å‘Šæ›¸ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: linear-gradient(45deg, #e91e63, #c2185b);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* çµ±è¨ˆã‚µãƒãƒªãƒ¼ */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stats-icon {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stats-icon.submitted {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .stats-icon.pending {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .stats-icon.total-sales {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .stats-info h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .stats-info p {
            color: #666;
            font-size: 0.875rem;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ã‚¨ãƒªã‚¢ */
        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .filter-input,
        .filter-select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #e91e63;
        }

        .filter-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(45deg, #e91e63, #c2185b);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        /* æ—¥å ±ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */
        .reports-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-button {
            padding: 0.5rem 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .reports-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .reports-table th,
        .reports-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .reports-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .reports-table tr:hover {
            background: #f8f9fa;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
            display: inline-block;
        }

        .status-submitted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-confirm {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
            font-weight: 600;
        }

        .btn-confirm:hover {
            background: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-view {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn-view:hover {
            background: #bbdefb;
        }

        .btn-edit {
            background: #fff3e0;
            color: #ef6c00;
        }

        .btn-edit:hover {
            background: #ffe0b2;
        }

        .btn-download {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .btn-download:hover {
            background: #c8e6c9;
        }

        /* å£²ä¸Šé‡‘é¡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ */
        .sales-amount {
            font-weight: 600;
            color: #2563eb;
            text-align: right;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ…‹ */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #059669;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #dc2626;
            color: #991b1b;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .stats-overview {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .reports-table {
                min-width: 800px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: #333;
        }

        .btn-confirm {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
            font-weight: 600;
        }

        .btn-confirm:hover {
            background: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
                /* ç¢ºå®šæ¸ˆã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        .status-confirmed {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #d97706;
        }

        .status-draft {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #9ca3af;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
        }

        /* ç¢ºå®šæ¸ˆã¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-confirmed {
            background: #fef3c7 !important;
            color: #92400e !important;
            border: 1px solid #d97706 !important;
            cursor: default !important;
            opacity: 0.8;
            font-weight: 600;
        }

        .btn-confirmed:hover {
            background: #fef3c7 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-confirmed::before {
            content: "ğŸ”’ ";
            margin-right: 4px;
        }

        /* è¿½åŠ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
            display: inline-block;
        }

        .quick-filter-btn {
            padding: 0.5rem 0.75rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
        }

        .quick-filter-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .clear-filter-btn {
            padding: 0.5rem 0.75rem;
            background: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #dc2626;
        }

        .clear-filter-btn:hover {
            background: #fecaca;
            border-color: #f87171;
            transform: translateY(-1px);
        }

        /* å¿…é ˆãƒãƒ¼ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .filter-label span {
            font-weight: bold;
        }

        /* æ¤œç´¢ãƒœã‚¿ãƒ³ã®å¼·åŒ– */
        .filter-button {
            position: relative;
            overflow: hidden;
        }

        .filter-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .filter-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* æ¤œç´¢çŠ¶æ…‹è¡¨ç¤º */
        .search-status-loading {
            background: #dbeafe !important;
            color: #1e40af !important;
            border: 1px solid #3b82f6;
        }

        .search-status-success {
            background: #d1fae5 !important;
            color: #065f46 !important;
            border: 1px solid #059669;
        }

        .search-status-error {
            background: #fee2e2 !important;
            color: #991b1b !important;
            border: 1px solid #dc2626;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <div class="header-left">
                <div class="admin-badge">ğŸ“Š æ—¥å ±ç®¡ç†</div>
                <div>
                    <h1 style="margin-bottom: 0.25rem;">æ—¥å ±ç®¡ç†</h1>
                    <div style="font-size: 0.875rem; color: #666;" id="userInfo">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
            <div class="nav-buttons">
                <a href="admin.html" class="nav-btn secondary">
                    <span>ğŸ </span>
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </a>
                <button class="nav-btn secondary" onclick="handleLogout()">
                    <span>ğŸšª</span>
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
            <div class="stats-overview">
                <div class="stats-card">
                    <div class="stats-icon submitted">âœ…</div>
                    <div class="stats-info">
                        <h3 id="submittedCount">-</h3>
                        <p>æå‡ºæ¸ˆã¿åº—èˆ—</p>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon pending">â³</div>
                    <div class="stats-info">
                        <h3 id="pendingCount">-</h3>
                        <p>æœªæå‡ºåº—èˆ—</p>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon total-sales">ğŸ’°</div>
                    <div class="stats-info">
                        <h3 id="totalSales">-</h3>
                        <p>åˆè¨ˆå£²ä¸Šé¡</p>
                    </div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ã‚¨ãƒªã‚¢ï¼ˆæ”¹å–„ç‰ˆï¼‰ -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">é–‹å§‹æ—¥ <span style="color: #dc2626;">*</span></label>
                        <input type="date" id="filterStartDate" class="filter-input" placeholder="é–‹å§‹æ—¥ã‚’é¸æŠ">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">çµ‚äº†æ—¥ <span style="color: #dc2626;">*</span></label>
                        <input type="date" id="filterEndDate" class="filter-input" placeholder="çµ‚äº†æ—¥ã‚’é¸æŠ">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">åº—èˆ—</label>
                        <select id="filterStore" class="filter-select">
                            <option value="">ã™ã¹ã¦ã®åº—èˆ—</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="filterStatus" class="filter-select">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="draft">æå‡ºæ¸ˆã¿</option>
                            <option value="approved">ç¢ºå®šæ¸ˆã¿</option>
                            <option value="pending">æœªæå‡º</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">&nbsp;</label>
                        <button class="filter-button" onclick="performSearch()" id="searchButton">
                            <span>ğŸ”</span> æ¤œç´¢
                        </button>
                    </div>
                </div>
                
                <!-- ä¾¿åˆ©ãƒœã‚¿ãƒ³ç¾¤ -->
                <div class="quick-filters" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 0.875rem; color: #666; margin-right: 0.5rem;">ã‚¯ã‚¤ãƒƒã‚¯è¨­å®š:</span>
                    <button class="quick-filter-btn" onclick="setTodayDate()" title="ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š">
                        ğŸ“… ä»Šæ—¥
                    </button>
                    <button class="quick-filter-btn" onclick="setThisWeekRange()" title="ä»Šé€±ã®ç¯„å›²ã‚’è¨­å®š">
                        ğŸ“… ä»Šé€±
                    </button>
                    <button class="quick-filter-btn" onclick="setLastWeekRange()" title="å…ˆé€±ã®ç¯„å›²ã‚’è¨­å®š">
                        ğŸ“… å…ˆé€±
                    </button>
                    <button class="quick-filter-btn" onclick="setThisMonthRange()" title="ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š">
                        ğŸ“… ä»Šæœˆ
                    </button>
                    <button class="quick-filter-btn" onclick="setLastMonthRange()" title="å…ˆæœˆã®ç¯„å›²ã‚’è¨­å®š">
                        ğŸ“… å…ˆæœˆ
                    </button>
                    <div style="flex: 1;"></div>
                    <button class="clear-filter-btn" onclick="clearDateRange()" title="ã™ã¹ã¦ã‚¯ãƒªã‚¢">
                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                    </button>
                </div>
                </div>
                
                <!-- æ¤œç´¢çŠ¶æ…‹è¡¨ç¤º -->
                <div id="searchStatus" style="margin-top: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; font-size: 0.875rem; color: #666; display: none;">
                    <span id="searchStatusText">æ¤œç´¢æ¡ä»¶ã‚’è¨­å®šã—ã¦ãã ã•ã„</span>
                </div>
            </div>

            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div id="alertContainer"></div>

            <!-- æ—¥å ±ä¸€è¦§ -->
            <div class="reports-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>ğŸ“‹</span>
                        æ—¥å ±ä¸€è¦§
                    </h2>
                    <button class="export-button" onclick="exportReports()">
                        <span>ğŸ“„</span> CSVå‡ºåŠ›
                    </button>
                </div>

                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>

                <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="reports-table-container" id="reportsTableContainer">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>åº—èˆ—å</th>
                                <th>æ‹…å½“è€…</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>å£²ä¸Šåˆè¨ˆ</th>
                                <th>ç¾é‡‘éä¸è¶³</th>
                                <th>æå‡ºæ—¥æ™‚</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- ãƒ‡ãƒ¼ã‚¿ãŒJavaScriptã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç©ºçŠ¶æ…‹ -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>æ—¥å ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                    <p>æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ—¥å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥å ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="reportDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ—¥å ±è©³ç´°</h3>
                <button class="close-btn" onclick="closeReportDetail()">&times;</button>
            </div>
            
            <div id="reportDetailContent">
                <!-- æ—¥å ±è©³ç´°å†…å®¹ãŒJavaScriptã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allReports = [];
        let allStores = [];
        let currentFilters = {
            date: '',
            store: '',
            status: ''
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializePage();
        });

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        function checkAuth() {
            const userSession = JSON.parse(sessionStorage.getItem('userSession') || 'null');
            
            if (!userSession || userSession.role !== 'admin') {
                alert('ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                window.location.href = 'login.html';
                return;
            }

            const userInfo = document.getElementById('userInfo');
            if (userInfo && userSession.username) {
                userInfo.textContent = `${userSession.username} ã•ã‚“ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;
            }
        }

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ï¼ˆå‰æ—¥æ—¥ä»˜è¨­å®šç‰ˆï¼‰
        async function initializePage() {
            try {
                console.log('æ—¥å ±ç®¡ç†ç”»é¢åˆæœŸåŒ–é–‹å§‹ï¼ˆæ¤œç´¢ãƒœã‚¿ãƒ³å¾…æ©Ÿï¼‰');
                disableSearchButton(true, 'åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                
                // å‰æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayString = yesterday.toISOString().split('T')[0];
                
                const startDateField = document.getElementById('filterStartDate');
                const endDateField = document.getElementById('filterEndDate');
                
                if (startDateField) {
                    startDateField.value = yesterdayString;
                    console.log('é–‹å§‹æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å‰æ—¥ã‚’è¨­å®š:', yesterdayString);
                }
                
                if (endDateField) {
                    endDateField.value = yesterdayString;
                    console.log('çµ‚äº†æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å‰æ—¥ã‚’è¨­å®š:', yesterdayString);
                }
                
                // åº—èˆ—ä¸€è¦§ã®ã¿èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿è¾¼ã¾ãªã„ï¼‰
                await loadStores();
                console.log('åº—èˆ—ä¸€è¦§ã®èª­ã¿è¾¼ã¿å®Œäº†');
                 disableSearchButton(false);

                // åˆæœŸçŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showInitialMessage();
                
                console.log('æ—¥å ±ç®¡ç†ç”»é¢åˆæœŸåŒ–å®Œäº†ï¼ˆæ¤œç´¢å¾…æ©ŸçŠ¶æ…‹ï¼‰');
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // åº—èˆ—ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadStores() {
            try {
                const response = await fetch('api.php?action=getAllStores');
                const result = await response.json();

                if (result.success) {
                    // æœ¬ç¤¾ã‚’é™¤å¤–ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    allStores = (result.data || []).filter(store => {
                        // åº—èˆ—åã«ã€Œæœ¬ç¤¾ã€ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯é™¤å¤–
                        return !store.store_name.includes('æœ¬ç¤¾');
                    });
                    console.log(`åº—èˆ—ä¸€è¦§ã‚’å–å¾—ï¼ˆæœ¬ç¤¾é™¤å¤–å¾Œ: ${allStores.length}ä»¶ï¼‰`);
                    updateStoreFilter();
                } else {
                    console.error('åº—èˆ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('åº—èˆ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updateStoreFilter() {
            const filterStore = document.getElementById('filterStore');
            filterStore.innerHTML = '<option value="">ã™ã¹ã¦ã®åº—èˆ—</option>';
            
            allStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.store_name;
                filterStore.appendChild(option);
            });
        }

        /**
         * æ—¥å ±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆä¸¦åˆ—å‡¦ç†ç‰ˆï¼‰
         */
        async function loadReports() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showInitialMessage();
                return;
            }
            
            showLoading(true);
            
            try {
                if (startDate > endDate) {
                    showAlert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const dateRange = getDateRange(startDate, endDate);
                console.log(`ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${startDate} ï½ ${endDate} (${dateRange.length}æ—¥)`);
                
                if (!allStores || allStores.length === 0) {
                    throw new Error('åº—èˆ—ä¸€è¦§ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆé…åˆ—ã‚’æº–å‚™
                const requestPromises = [];
                
                // å„åº—èˆ—ãƒ»å„æ—¥ä»˜ã®çµ„ã¿åˆã‚ã›ã§Promiseã‚’ä½œæˆ
                for (const store of allStores) {
                    for (const date of dateRange) {
                        const promise = fetchReportData(store, date);
                        requestPromises.push(promise);
                    }
                }
                
                console.log(`ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: ${requestPromises.length}`);
                
                // ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
                const results = await Promise.allSettled(requestPromises);
                
                // çµæœã‚’å‡¦ç†
                const reports = [];
                let successCount = 0;
                let errorCount = 0;
                
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        reports.push(result.value);
                        successCount++;
                    } else {
                        console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', result.reason);
                        errorCount++;
                    }
                });
                
                console.log(`ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${reports.length}ä»¶ (æˆåŠŸ: ${successCount}, ã‚¨ãƒ©ãƒ¼: ${errorCount})`);
                
                allReports = reports;
                applyFilters();
                updateStats();
                
                if (errorCount > 0) {
                    showAlert(`ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${reports.length}ä»¶ï¼‰\nä¸€éƒ¨å–å¾—ã§ããªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã—ãŸï¼ˆ${errorCount}ä»¶ï¼‰`, 'warning');
                }
                
            } catch (error) {
                console.error('ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                allReports = [];
                showInitialMessage();
            } finally {
                showLoading(false);
            }
        }

        // æ—¥ä»˜ç¯„å›²ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getDateRange(startDate, endDate) {
            const dates = [];
            const currentDate = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            while (currentDate <= endDateObj) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }

        // å£²ä¸Šåˆè¨ˆã‚’è¨ˆç®—
        function calculateTotalSales(reportData) {
            try {
                let total = 0;
                
                // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
                if (reportData.sales_data) {
                    const salesData = typeof reportData.sales_data === 'string' 
                        ? JSON.parse(reportData.sales_data) 
                        : reportData.sales_data;
                    
                    Object.values(salesData).forEach(amount => {
                        total += parseFloat(amount) || 0;
                    });
                }
                
                // ãƒã‚¤ãƒ³ãƒˆæ”¯æ‰•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
                if (reportData.point_payments_data) {
                    const pointData = typeof reportData.point_payments_data === 'string' 
                        ? JSON.parse(reportData.point_payments_data) 
                        : reportData.point_payments_data;
                    
                    Object.values(pointData).forEach(amount => {
                        total += parseFloat(amount) || 0;
                    });
                }
                
                return total;
            } catch (error) {
                console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                return 0;
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function applyFilters() {
            console.log('=== applyFilters å®Ÿè¡Œé–‹å§‹ ===');
            
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:', {startDate, endDate});
            
            // æ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (!startDate || !endDate) {
                console.log('æ—¥ä»˜ãŒæœªè¨­å®šã®ãŸã‚åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º');
                showInitialMessage();
                return;
            }
            
            // window.allReportsã‚’ä½¿ç”¨
            if (!window.allReports || !Array.isArray(window.allReports)) {
                console.error('window.allReportsãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“:', window.allReports);
                showInitialMessage();
                return;
            }
            
            currentFilters.startDate = startDate;
            currentFilters.endDate = endDate;
            currentFilters.store = document.getElementById('filterStore').value;
            currentFilters.status = document.getElementById('filterStatus').value;
            
            console.log('è¨­å®šã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:', currentFilters);
            
            let filteredReports = [...window.allReports];
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰:', filteredReports.length);
            
            // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (currentFilters.startDate && currentFilters.endDate) {
                filteredReports = filteredReports.filter(report => 
                    report.report_date >= currentFilters.startDate && 
                    report.report_date <= currentFilters.endDate
                );
                console.log('æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:', filteredReports.length);
            }
            
            // åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (currentFilters.store) {
                filteredReports = filteredReports.filter(report => 
                    report.store_id == currentFilters.store
                );
                console.log('åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:', filteredReports.length);
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (currentFilters.status) {
                if (currentFilters.status === 'draft') {
                    // ã€Œæå‡ºæ¸ˆã¿ã€ã‚’é¸æŠã—ãŸå ´åˆã€draftã¨submittedã®ä¸¡æ–¹ã‚’å«ã‚ã‚‹
                    filteredReports = filteredReports.filter(report => 
                        report.status === 'draft' || report.status === 'submitted'
                    );
                } else if (currentFilters.status === 'approved') {
                    // ã€Œç¢ºå®šæ¸ˆã¿ã€ã‚’é¸æŠã—ãŸå ´åˆã€approvedã®ã¿
                    filteredReports = filteredReports.filter(report => 
                        report.status === 'approved'
                    );
                } else {
                    filteredReports = filteredReports.filter(report => 
                        report.status === currentFilters.status
                    );
                }
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:', filteredReports.length);
            }
            
            console.log('æœ€çµ‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ:', filteredReports.length);
            
            // ç°¡æ˜“ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
            const tbody = document.getElementById('reportsTableBody');
            const tableContainer = document.getElementById('reportsTableContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredReports.length > 0) {
                tableContainer.style.display = 'block';
                emptyState.style.display = 'none';
                
                tbody.innerHTML = filteredReports.map(report => `
                    <tr>
                        <td>${formatDate(report.report_date)}</td>
                        <td><strong>${escapeHtml(report.store_name)}</strong></td>
                        <td>${escapeHtml(report.user_id || '-')}</td>
                        <td>${getStatusBadge(report.status)}</td>
                        <td class="sales-amount">${formatCurrency(report.total_sales)}</td>
                        <td style="text-align: right;">${formatCurrency(report.cash_difference)}</td>
                        <td>${formatDateTime(report.updated_at)}</td>
                        <td>
                            <div class="action-buttons">
                                ${getActionButtons(report)}
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºå®Œäº†');
            } else {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                console.log('ãƒ‡ãƒ¼ã‚¿0ä»¶ã®ãŸã‚ç©ºçŠ¶æ…‹è¡¨ç¤º');
            }
        }

        /**
         * ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆstatuså¯¾å¿œç‰ˆï¼‰
         */
        function renderReportsTable(reports) {
            const tbody = document.getElementById('reportsTableBody');
            const tableContainer = document.getElementById('reportsTableContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (reports.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>${formatDate(report.report_date)}</td>
                    <td><strong>${escapeHtml(report.store_name)}</strong></td>
                    <td>${escapeHtml(report.user_id || '-')}</td>
                    <td>${getStatusBadge(report.status)}</td>
                    <td class="sales-amount">${formatCurrency(report.total_sales)}</td>
                    <td style="text-align: right; ${report.cash_difference > 0 ? 'color: #059669;' : report.cash_difference < 0 ? 'color: #dc2626;' : ''}">${formatCurrency(report.cash_difference)}</td>
                    <td>${formatDateTime(report.updated_at)}</td>
                    <td>
                        <div class="action-buttons">
                            ${getActionButtons(report)}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const submitted = allReports.filter(r => r.status === 'submitted' || r.status === 'draft').length;
            const pending = allReports.filter(r => r.status === 'pending').length;
            const totalSales = allReports
                .filter(r => r.status === 'submitted' || r.status === 'draft')
                .reduce((sum, r) => sum + r.total_sales, 0);
            
            document.getElementById('submittedCount').textContent = submitted;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
        }

        /**
         * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ç”Ÿæˆï¼ˆstatuså¯¾å¿œç‰ˆï¼‰
         */
        function getStatusBadge(status) {
            const badges = {
                'submitted': '<span class="status-badge status-submitted">âœ… æå‡ºæ¸ˆã¿</span>',
                'approved': '<span class="status-badge status-confirmed">âœ… ç¢ºå®šæ¸ˆã¿</span>',
                'draft': '<span class="status-badge status-draft">ğŸ“ æå‡ºæ¸ˆã¿</span>',
                'rejected': '<span class="status-badge status-rejected">âŒ å´ä¸‹</span>',
                'pending': '<span class="status-badge status-pending">â³ æœªæå‡º</span>'
            };
            return badges[status] || '<span class="status-badge">ä¸æ˜</span>';
        }

        /**
         * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç”Ÿæˆï¼ˆstatuså¯¾å¿œç‰ˆãƒ»ä¿®æ­£ç‰ˆï¼‰
         */
        function getActionButtons(report) {
            if (!report.id) {
                // æœªæå‡ºã®å ´åˆ
                return `<button class="btn-small btn-edit" onclick="createReport(${report.store_id}, '${report.report_date}')">âœï¸ ä½œæˆ</button>`;
            }
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            console.log(`Report ID: ${report.id}, Status: ${report.status}, Date: ${report.report_date}`);
            
            // æå‡ºæ¸ˆã¿ã®å ´åˆï¼ˆstatusã®ç¢ºèªã‚’å¼·åŒ–ï¼‰
            if (report.status === 'approved') {
                // ç¢ºå®šæ¸ˆã¿ã®å ´åˆï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰
                return `
                    <button class="btn-small btn-confirmed" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')" title="ã“ã®æ—¥å ±ã¯ç¢ºå®šæ¸ˆã¿ã§ã™">ğŸ”’ ç¢ºå®šæ¸ˆã¿</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">ğŸ‘ï¸ è©³ç´°</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">ğŸ“„ PDF</button>
                `;
            } else if (report.status === 'submitted') {
                // æå‡ºæ¸ˆã¿ãƒ»æœªç¢ºå®šã®å ´åˆ
                return `
                    <button class="btn-small btn-confirm" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">ğŸ“‹ ç¢ºèª</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">ğŸ‘ï¸ è©³ç´°</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">ğŸ“„ PDF</button>
                `;
            } else if (report.status === 'draft') {
                // ä¸‹æ›¸ãã®å ´åˆ
                return `
                    <button class="btn-small btn-edit" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">âœï¸ ç·¨é›†</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">ğŸ‘ï¸ è©³ç´°</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">ğŸ“„ PDF</button>
                `;
            } else if (report.status === 'rejected') {
                // å´ä¸‹ã®å ´åˆ
                return `
                    <button class="btn-small btn-edit" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">ğŸ”„ å†ç·¨é›†</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">ğŸ‘ï¸ è©³ç´°</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">ğŸ“„ PDF</button>
                `;
            } else {
                // ãã®ä»–ãƒ»ä¸æ˜ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                console.warn(`Unknown status: ${report.status} for report ID: ${report.id}`);
                return `
                    <button class="btn-small btn-view" onclick="viewReportInForm(${report.store_id}, '${report.report_date}')">ğŸ“‹ ç¢ºèª</button>
                    <button class="btn-small btn-view" onclick="viewReportDetail(${report.id})">ğŸ‘ï¸ è©³ç´°</button>
                    <button class="btn-small btn-download" onclick="downloadReport(${report.id})">ğŸ“„ PDF</button>
                `;
            }
        }

        // æ—¥å ±è©³ç´°è¡¨ç¤º
        async function viewReportDetail(reportId) {
            try {
                // APIã‹ã‚‰è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const report = allReports.find(r => r.id == reportId);
                if (!report) return;
                
                const detailContent = document.getElementById('reportDetailContent');
                detailContent.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">æ—¥ä»˜</div>
                            <div class="detail-value">${formatDate(report.report_date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">åº—èˆ—</div>
                            <div class="detail-value">${escapeHtml(report.store_name)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‹…å½“è€…</div>
                            <div class="detail-value">${escapeHtml(report.user_id)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å£²ä¸Šåˆè¨ˆ</div>
                            <div class="detail-value">${formatCurrency(report.total_sales)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç¾é‡‘éä¸è¶³</div>
                            <div class="detail-value">${formatCurrency(report.cash_difference)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æå‡ºæ—¥æ™‚</div>
                            <div class="detail-value">${formatDateTime(report.updated_at)}</div>
                        </div>
                    </div>
                    
                    ${report.remarks ? `
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">å‚™è€ƒãƒ»å ±å‘Šäº‹é …</h4>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(report.remarks)}</div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('reportDetailModal').classList.add('show');
                
            } catch (error) {
                console.error('è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showAlert('è©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ—¥å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ã§ç¢ºèª
        function viewReportInForm(storeId, reportDate) {
            try {
                console.log(`æ—¥å ±ç¢ºèª: åº—èˆ—ID=${storeId}, æ—¥ä»˜=${reportDate}`);
                
                // index.htmlã«åº—èˆ—IDã¨æ—¥ä»˜ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
                const url = `index.html?store_id=${storeId}&date=${reportDate}&mode=view`;
                window.open(url, '_blank');
                
            } catch (error) {
                console.error('æ—¥å ±ç¢ºèªã§ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('æ—¥å ±ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ—¥å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ã§ç¢ºèª
        function viewReportInForm(storeId, reportDate) {
            try {
                console.log(`æ—¥å ±ç¢ºèª: åº—èˆ—ID=${storeId}, æ—¥ä»˜=${reportDate}`);
                
                // index.htmlã«åº—èˆ—IDã¨æ—¥ä»˜ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
                const url = `index.html?store_id=${storeId}&date=${reportDate}&mode=view`;
                window.open(url, '_blank');
                
            } catch (error) {
                console.error('æ—¥å ±ç¢ºèªã§ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('æ—¥å ±ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ—¥å ±ä½œæˆ
        function createReport(storeId, date) {
            const url = `index.html?store_id=${storeId}&date=${date}&mode=create`;
            window.open(url, '_blank');
        }

        // PDFå‡ºåŠ›
        function downloadReport(reportId) {
            // PDFç”Ÿæˆæ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®š
            showAlert('PDFå‡ºåŠ›æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'error');
        }

        // CSVå‡ºåŠ›
        function exportReports() {
            try {
                const filteredReports = allReports.filter(report => {
                    if (currentFilters.store && report.store_id != currentFilters.store) return false;
                    if (currentFilters.status && report.status !== currentFilters.status) return false;
                    return true;
                });
                
                const csvData = [
                    ['æ—¥ä»˜', 'åº—èˆ—å', 'æ‹…å½“è€…', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å£²ä¸Šåˆè¨ˆ', 'ç¾é‡‘éä¸è¶³', 'æå‡ºæ—¥æ™‚'],
                    ...filteredReports.map(report => [
                        report.report_date,
                        report.store_name,
                        report.user_id || '-',
                        report.status === 'draft' ? 'æå‡ºæ¸ˆã¿' : 
                        report.status === 'approved' ? 'ç¢ºå®šæ¸ˆã¿' : 
                        report.status === 'submitted' ? 'æå‡ºæ¸ˆã¿' : 
                        report.status === 'pending' ? 'æœªæå‡º' : 'ä¸æ˜',
                        report.total_sales,
                        report.cash_difference,
                        report.updated_at || '-'
                    ])
                ];
                
                const csvContent = csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `æ—¥å ±ä¸€è¦§_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
            } catch (error) {
                console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeReportDetail() {
            document.getElementById('reportDetailModal').classList.remove('show');
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }

        function formatCurrency(amount) {
            return `Â¥${amount.toLocaleString()}`;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('reportDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportDetail();
            }
        });

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeReportDetail();
            }
        });

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å…¥åŠ›æ™‚ã®è‡ªå‹•æ›´æ–°
        document.getElementById('filterStartDate').addEventListener('change', validateDateRange);
        document.getElementById('filterEndDate').addEventListener('change', validateDateRange);

        // æ—¥ä»˜ç¯„å›²ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•èª­ã¿è¾¼ã¿ãªã—ç‰ˆï¼‰
        function validateDateRange() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const searchButton = document.getElementById('searchButton');
            const searchStatus = document.getElementById('searchStatus');
            const searchStatusText = document.getElementById('searchStatusText');
            
            if (startDate && endDate) {
                if (startDate > endDate) {
                    // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
                    document.getElementById('filterStartDate').style.borderColor = '#dc2626';
                    document.getElementById('filterEndDate').style.borderColor = '#dc2626';
                    if (searchButton) searchButton.disabled = true;
                    
                    if (searchStatus && searchStatusText) {
                        searchStatus.style.display = 'block';
                        searchStatus.className = 'search-status-error';
                        searchStatusText.textContent = 'é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„';
                    }
                } else {
                    // æ­£å¸¸çŠ¶æ…‹
                    document.getElementById('filterStartDate').style.borderColor = '#059669';
                    document.getElementById('filterEndDate').style.borderColor = '#059669';
                    if (searchButton) searchButton.disabled = false;
                    
                    // æœŸé–“ã®æ—¥æ•°ã‚’è¡¨ç¤º
                    const daysDiff = Math.floor((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                    
                    if (searchStatus && searchStatusText) {
                        searchStatus.style.display = 'block';
                        searchStatus.className = '';
                        searchStatusText.textContent = `${daysDiff + 1}æ—¥é–“ã®æœŸé–“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`;
                    }
                }
            } else {
                // å…¥åŠ›é€”ä¸­
                document.getElementById('filterStartDate').style.borderColor = '';
                document.getElementById('filterEndDate').style.borderColor = '';
                if (searchButton) searchButton.disabled = !startDate || !endDate;
                
                if (searchStatus) {
                    searchStatus.style.display = 'none';
                }
            }
        }
/**
 * åˆæœŸçŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆå‰æ—¥æ—¥ä»˜è¨­å®šç‰ˆï¼‰
 */
function showInitialMessage() {
    const reportsTableContainer = document.getElementById('reportsTableContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (reportsTableContainer && emptyState) {
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’éè¡¨ç¤º
        reportsTableContainer.style.display = 'none';
        
        // å‰æ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayString = yesterday.toLocaleDateString('ja-JP');
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #666;">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">ğŸ“‹</div>
                <h3 style="margin-bottom: 1rem; color: #333;">æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</h3>
                <p style="margin-bottom: 0.5rem;">åˆæœŸè¨­å®šã§å‰æ—¥ï¼ˆ${yesterdayString}ï¼‰ã®ç¯„å›²ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™</p>
                <p style="font-size: 0.875rem; opacity: 0.7;">æ—¥ä»˜ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰ã€ŒğŸ” æ¤œç´¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            </div>
        `;
        console.log('åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆå‰æ—¥æ—¥ä»˜è¨­å®šæ¸ˆã¿ï¼‰');
    }
    
    // çµ±è¨ˆã‚‚åˆæœŸçŠ¶æ…‹ã«è¨­å®š
    resetStats();
}

/**
 * çµ±è¨ˆã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
 */
function resetStats() {
    try {
        document.getElementById('submittedCount').textContent = '-';
        document.getElementById('pendingCount').textContent = '-';
        document.getElementById('totalSales').textContent = '-';
        console.log('çµ±è¨ˆã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ');
    } catch (error) {
        console.error('çµ±è¨ˆãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
    }
}

/**
 * æ¤œç´¢å‡¦ç†ï¼ˆãƒãƒƒãƒAPIä½¿ç”¨ç‰ˆï¼‰
 */
async function performSearch() {
    console.log('é«˜é€Ÿæ¤œç´¢å‡¦ç†é–‹å§‹');
    
    try {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        // å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!startDate || !endDate) {
            showAlert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’ä¸¡æ–¹ã¨ã‚‚é¸æŠã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        // æ—¥ä»˜å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        if (startDate > endDate) {
            showAlert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        // æœŸé–“åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ30æ—¥ä»¥å†…æ¨å¥¨ï¼‰
        const daysDiff = Math.floor((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
        if (daysDiff > 30) {
            if (!confirm(`${daysDiff + 1}æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
        }
        
        console.log(`é«˜é€Ÿæ¤œç´¢å®Ÿè¡Œ: ${startDate} ï½ ${endDate} (${daysDiff + 1}æ—¥é–“)`);
        
        // ãƒãƒƒãƒAPIç‰ˆã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Ÿè¡Œ
        await loadReportsFast();
        
    } catch (error) {
        console.error('é«˜é€Ÿæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        showAlert('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    }
}

    /**
     * ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®šã™ã‚‹ãƒœã‚¿ãƒ³
     */
    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterStartDate').value = today;
        document.getElementById('filterEndDate').value = today;
        console.log('ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š:', today);
    }

    /**
     * ä»Šé€±ã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®šã™ã‚‹ãƒœã‚¿ãƒ³
     */
    function setThisWeekRange() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0=æ—¥æ›œæ—¥, 1=æœˆæ›œæ—¥, ...
        const monday = new Date(today);
        monday.setDate(today.getDate() - dayOfWeek + 1); // æœˆæ›œæ—¥
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // æ—¥æ›œæ—¥
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        document.getElementById('filterStartDate').value = startDate;
        document.getElementById('filterEndDate').value = endDate;
        console.log('ä»Šé€±ã®ç¯„å›²ã‚’è¨­å®š:', startDate, 'ï½', endDate);
    }

    /**
     * å…ˆé€±ã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®š
     */
    function setLastWeekRange() {
        const today = new Date();
        const dayOfWeek = today.getDay();
        const lastMonday = new Date(today);
        lastMonday.setDate(today.getDate() - dayOfWeek - 6); // å…ˆé€±ã®æœˆæ›œæ—¥
        const lastSunday = new Date(lastMonday);
        lastSunday.setDate(lastMonday.getDate() + 6); // å…ˆé€±ã®æ—¥æ›œæ—¥
        
        const startDate = lastMonday.toISOString().split('T')[0];
        const endDate = lastSunday.toISOString().split('T')[0];
        
        document.getElementById('filterStartDate').value = startDate;
        document.getElementById('filterEndDate').value = endDate;
        console.log('å…ˆé€±ã®ç¯„å›²ã‚’è¨­å®š:', startDate, 'ï½', endDate);
    }

    /**
     * ä»Šæœˆã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰
     */
    function setThisMonthRange() {
        const today = new Date();
        
        // ä»Šæœˆã®1æ—¥
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // ä»Šæœˆã®æœ€çµ‚æ—¥
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç”Ÿæˆï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
        const startDate = formatDateLocal(firstDay);
        const endDate = formatDateLocal(lastDay);
        
        document.getElementById('filterStartDate').value = startDate;
        document.getElementById('filterEndDate').value = endDate;
        
        // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
        const searchStatus = document.getElementById('searchStatus');
        const searchStatusText = document.getElementById('searchStatusText');
        if (searchStatus && searchStatusText) {
            searchStatus.style.display = 'block';
            searchStatus.className = '';
            const dayCount = lastDay.getDate();
            searchStatusText.textContent = `ä»Šæœˆã®ç¯„å›²ï¼ˆ${dayCount}æ—¥é–“ï¼‰ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`;
        }
        
        console.log('ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š:', startDate, 'ï½', endDate);
    }

    /**
 * å…ˆæœˆã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®š
 */
function setLastMonthRange() {
    const today = new Date();
    
    // å…ˆæœˆã®1æ—¥
    const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    
    // å…ˆæœˆã®æœ€çµ‚æ—¥
    const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç”Ÿæˆï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    const startDate = formatDateLocal(firstDay);
    const endDate = formatDateLocal(lastDay);
    
    document.getElementById('filterStartDate').value = startDate;
    document.getElementById('filterEndDate').value = endDate;
    
    // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
    const searchStatus = document.getElementById('searchStatus');
    const searchStatusText = document.getElementById('searchStatusText');
    if (searchStatus && searchStatusText) {
        searchStatus.style.display = 'block';
        searchStatus.className = '';
        const dayCount = lastDay.getDate();
        const monthName = lastDay.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
        searchStatusText.textContent = `${monthName}ã®ç¯„å›²ï¼ˆ${dayCount}æ—¥é–“ï¼‰ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`;
    }
    
    console.log('å…ˆæœˆã®ç¯„å›²ã‚’è¨­å®š:', startDate, 'ï½', endDate);
}

    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
     * @param {Date} date 
     * @returns {string} YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—
     */
    function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    /**
     * æ—¥ä»˜ç¯„å›²ã®ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
     */
    function clearDateRange() {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterStore').value = '';
        document.getElementById('filterStatus').value = '';
        
        // åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        allReports = [];
        showInitialMessage();
        
        console.log('æ—¥ä»˜ç¯„å›²ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢');
    }
    /**
     * å€‹åˆ¥ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆPromiseå¯¾å¿œï¼‰
     */
    async function fetchReportData(store, date) {
        try {
            const response = await fetch(`api.php?action=getReport&report_date=${date}&store_id=${store.id}`);
            const result = await response.json();
            
            if (result.success) {
                // æå‡ºæ¸ˆã¿
                const reportData = result.data;
                const status = reportData.status || 'submitted';
                
                return {
                    ...reportData,
                    store_name: store.store_name,
                    status: status,
                    total_sales: calculateTotalSales(reportData)
                };
            } else {
                // æœªæå‡º
                return {
                    id: null,
                    report_date: date,
                    store_id: store.id,
                    store_name: store.store_name,
                    user_id: '-',
                    status: 'pending',
                    total_sales: 0,
                    cash_difference: 0,
                    created_at: null,
                    updated_at: null
                };
            }
        } catch (error) {
            console.error(`åº—èˆ— ${store.store_name} - ${date} ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æœªæå‡ºã¨ã—ã¦è¿”ã™
            return {
                id: null,
                report_date: date,
                store_id: store.id,
                store_name: store.store_name,
                user_id: '-',
                status: 'pending',
                total_sales: 0,
                cash_difference: 0,
                created_at: null,
                updated_at: null
            };
        }
    }

    /**
     * ãƒãƒƒãƒAPIä½¿ç”¨ç‰ˆã®é«˜é€Ÿãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
     */
    async function loadReportsFast() {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        if (!startDate || !endDate) {
            showInitialMessage();
            return;
        }
        
        showLoading(true);
        
        try {
            if (!allStores || allStores.length === 0) {
                throw new Error('åº—èˆ—ä¸€è¦§ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }
            
            // åº—èˆ—IDã®é…åˆ—ã‚’ä½œæˆ
            const storeIds = allStores.map(store => store.id);
            
            console.log(`ãƒãƒƒãƒAPIå‘¼ã³å‡ºã—: ${startDate} ï½ ${endDate}, åº—èˆ—æ•°: ${storeIds.length}`);
            
            // ãƒãƒƒãƒAPIã‚’å‘¼ã³å‡ºã—
            const response = await fetch('api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'getBatchReports',
                    start_date: startDate,
                    end_date: endDate,
                    store_ids: storeIds
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const existingReports = result.data;
                console.log(`ãƒãƒƒãƒAPIå–å¾—å®Œäº†: ${existingReports.length}ä»¶ã®æ—¢å­˜ãƒ¬ãƒãƒ¼ãƒˆ`);
                
                // å…¨çµ„ã¿åˆã‚ã›ã‚’ç”Ÿæˆã—ã¦æœªæå‡ºãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œ
                const completeReports = generateCompleteReportSet(startDate, endDate, allStores, existingReports);
                console.log(`ãƒ‡ãƒ¼ã‚¿è£œå®Œå®Œäº†: ${completeReports.length}ä»¶ã®å…¨ãƒ¬ãƒãƒ¼ãƒˆ`);
                
                window.allReports = completeReports;
                console.log('âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°è¨­å®šç¢ºèª:', window.allReports ? window.allReports.length : 'FAILED');
                if (window.allReports && window.allReports.length > 0) {
                    console.log('applyFilters() ã‚’å®Ÿè¡Œ');
                    applyFilters();
                    updateStats();
                } else {
                    console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®è¨­å®šã«å¤±æ•—');
                    showInitialMessage();
                }
                
            } else {
                throw new Error(result.message || 'ãƒãƒƒãƒAPIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
        } catch (error) {
            console.error('é«˜é€Ÿãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            showAlert('æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            window.allReports = [];
            showInitialMessage();
        } finally {
            showLoading(false);
        }
    }

    /**
     * å®Œå…¨ãªãƒ¬ãƒãƒ¼ãƒˆã‚»ãƒƒãƒˆã‚’ç”Ÿæˆï¼ˆæœªæå‡ºãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œï¼‰
     */
    function generateCompleteReportSet(startDate, endDate, stores, existingReports) {
        const dateRange = getDateRange(startDate, endDate);
        const completeReports = [];
        
        // æ—¢å­˜ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒãƒƒãƒ—åŒ–ï¼ˆé«˜é€Ÿæ¤œç´¢ç”¨ï¼‰
        const existingMap = new Map();
        existingReports.forEach(report => {
            const key = `${report.store_id}-${report.report_date}`;
            // å£²ä¸Šåˆè¨ˆã‚’è¨ˆç®—
            report.total_sales = calculateTotalSalesFromData(report);
            existingMap.set(key, report);
        });
        
        // å…¨çµ„ã¿åˆã‚ã›ã‚’ãƒã‚§ãƒƒã‚¯
        stores.forEach(store => {
            dateRange.forEach(date => {
                const key = `${store.id}-${date}`;
                
                if (existingMap.has(key)) {
                    // æ—¢å­˜ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆ
                    const existingReport = existingMap.get(key);
                    completeReports.push({
                        ...existingReport,
                        store_name: store.store_name
                    });
                } else {
                    // æœªæå‡ºã®å ´åˆ
                    completeReports.push({
                        id: null,
                        report_date: date,
                        store_id: store.id,
                        store_name: store.store_name,
                        user_id: '-',
                        status: 'pending',
                        total_sales: 0,
                        cash_difference: 0,
                        created_at: null,
                        updated_at: null
                    });
                }
            });
        });
        
        return completeReports;
    }

    /**
     * ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å£²ä¸Šåˆè¨ˆã‚’è¨ˆç®—
     */
    function calculateTotalSalesFromData(reportData) {
        try {
            let total = 0;
            
            if (reportData.sales_data) {
                Object.values(reportData.sales_data).forEach(amount => {
                    total += parseFloat(amount) || 0;
                });
            }
            
            if (reportData.point_payments_data) {
                Object.values(reportData.point_payments_data).forEach(amount => {
                    total += parseFloat(amount) || 0;
                });
            }
            
            return total;
        } catch (error) {
            return 0;
        }
    }

    /**
 * æ¤œç´¢ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¶å¾¡
 * @param {boolean} disabled true=ç„¡åŠ¹, false=æœ‰åŠ¹
 * @param {string} message ç„¡åŠ¹æ™‚ã«è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
function disableSearchButton(disabled, message = '') {
    const searchButton = document.getElementById('searchButton');
    const searchStatus = document.getElementById('searchStatus');
    const searchStatusText = document.getElementById('searchStatusText');
    
    if (!searchButton) return;
    
    if (disabled) {
        // ç„¡åŠ¹åŒ–
        searchButton.disabled = true;
        searchButton.style.opacity = '0.6';
        searchButton.style.cursor = 'not-allowed';
        searchButton.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>${message || 'å‡¦ç†ä¸­...'}</span>
            </div>
        `;
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        if (searchStatus && searchStatusText) {
            searchStatus.style.display = 'block';
            searchStatus.className = 'search-status-loading';
            searchStatusText.textContent = message || 'åˆæœŸåŒ–ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
        }
        
    } else {
        // æœ‰åŠ¹åŒ–
        searchButton.disabled = false;
        searchButton.style.opacity = '1';
        searchButton.style.cursor = 'pointer';
        searchButton.innerHTML = `
            <span>ğŸ”</span> æ¤œç´¢
        `;
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹éè¡¨ç¤º
        if (searchStatus) {
            searchStatus.style.display = 'none';
        }
        
        console.log('âœ… æ¤œç´¢ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
    }
}

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSè¿½åŠ ï¼ˆ1å›ã®ã¿ï¼‰
    if (!document.getElementById('searchButtonSpinCSS')) {
        const style = document.createElement('style');
        style.id = 'searchButtonSpinCSS';
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
        
    </script>
</body>
</html>